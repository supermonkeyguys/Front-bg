


#### TCP （Transmission Control Protocol）

#### UDP （User Datagram Protocol）

是 **传输层（Transport Layer）的两个核心协议**，都运行在 **IP 协议** 之上，用于在网络中传输数据。



| 特性   | TCP                     | UDP                               |
| ---- | ----------------------- | --------------------------------- |
| 连接方式 | 面向连接（三次握手建立连接）          | 无连接（直接发送数据包）                      |
| 可靠性  | 可靠：保证数据不丢失、不重复、按序到达     | 不可靠：可能丢包、乱序、重复                    |
| 传输效率 | 较低（需确认、重传、流量控制等开销）      | 高（无连接、无确认，头小）                     |
| 头部大小 | 20~60字节（含选项）            | 固定 8 字节                           |
| 数据边界 | 无消息边界（流式传输）             | 有消息边界（每个 UDP 包独立）                 |
| 拥塞控制 | 有（慢启动、拥塞避免等）            | 无（应用层自行控制）                        |
| 适用场景 | 文件传输、网页、邮件、数据库等需要可靠性的场景 | 视频会议、直播、游戏、DNS、IoT 等容忍丢包但要求低延迟的场景 |



**连接机制**：

- **TCP**：必须先通过 **三次握手（SYN -> SYN-ACK -> ACK）**建立连接，通信结束后通过 **四次挥手** 断开连接
- **UDP**：无需握手，直接发送数据包（`sendto`），接受方用 `recvfrom` 接收



## TCP


### 三次握手

**目的：可靠地建立双向连接，确保双方都能发送和接收数据**

**客户端 -> 服务端**

| 发送方 -> 接收方 | 标志位（FLAGS）                           | 说明                        |
| ---------- | ------------------------------------ | ------------------------- |
| 客户端 -> 服务端 | `SYN=1`, `seq=x`                     | 客户端请求建立连接，初始序号 `x`        |
| 服务端 -> 客户端 | `SYN=1`, `ACK=1`, `seq=y`, `ack=x+1` | 服务器确认客户端请求，并发送自己的初始序号 `y` |
| 客户端 -> 服务端 | `ACK=1`, `seq=x+1`, `ack=y+1`        | 客户端确认服务器的序号, 连接建立完成       |

- **SYN**（Synchronize）：同步序号，表示连接请求。
- **ACK**（Acknowledgment）：确认号有效。
- **seq**（Sequence Number）：当前包的序号。
- **ack**（Acknowledgment Number）：期望收到的下一个序号（即 `对方seq + 1`）。



### 四次挥手


**目的：安全地关闭双向连接（TCP 是全双工，需分别关闭两个方向）**


| 发送方 -> 接收方 | 标志位                                  | 说明                            |
| ---------- | ------------------------------------ | ----------------------------- |
| 客户端 → 服务器  | `FIN=1`, `seq=u`                     | 客户端数据发完，请求关闭**客户端→服务器**方向     |
| 服务器 → 客户端  | `ACK=1`, `seq=v`, `ack=u+1`          | 服务器确认收到 FIN（但**服务器可能还有数据要发**） |
| 服务器 → 客户端  | `FIN=1`, `ACK=1`, `seq=w`, `ack=u+1` | 服务器数据也发完，请求关闭**服务器→客户端**方向    |
| 客户端 → 服务器  | `ACK=1`, `seq=u+1`, `ack=w+1`        | 客户端确认服务器的 FIN，连接完全关闭          |

- **FIN**（Finish）：表示“我的数据发完了”。
- **TIME_WAIT 状态**：主动关闭方（客户端）在第 4 步后会进入 `TIME_WAIT`（持续 2×MSL，约 60 秒）：
    - 确保最后一个 ACK 被服务器收到（若丢失，服务器会重发 FIN）。
    - 防止旧连接的延迟包干扰新连接。